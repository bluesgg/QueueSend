# 跨平台 ROI 变化驱动自动化工具 PRD

版本：v1.1-精简版  
日期：2026-01-02

---

## 1. 问题与目标

在浏览器、Cursor、VS Code、antigravity 等应用中,用户需批量发送多条文本。工具通过"点击输入点→粘贴→点击发送→冷却→ROI变化判定"流程自动化发送,完全依赖屏幕ROI变化检测推进(不读取应用内部状态)。

**核心约束**:目标窗口运行期间不移动/缩放/滚动;每次运行重新标定。

**成功指标**:
- 2分钟内完成标定并成功运行
- ROI变化满足条件后自动推进,Pause/Resume/Stop正确执行
- 连续运行30分钟无崩溃,CPU稳定(1 FPS采样)

---

## 2. 平台与假设

**平台**: Windows、macOS(仅单显示器)  
**目标应用**: 浏览器、Cursor、VS Code、antigravity(作为被操作窗口,不做集成)

**非目标**:
- 不支持运行中跟踪窗口位置变化
- 不做视觉/控件自动识别
- 不支持超时自动失败(无限等待,靠Pause/Stop控制)
- 不支持应用内部注入/读取DOM

---

## 3. UI与交互

### 3.1 运行面板(小窗)
- Always on top
- Start后吸附到**发送按钮坐标所在屏幕**右下角(边距12±2px逻辑像素)
- Start后倒计时2秒,再执行自动化
- 显示: 进度i/N(1-based,例如1/5)、状态(Idle/Countdown/Sending/Cooling/WaitingHold/Paused)、Pause/Resume/Stop、日志(环形缓冲200条)
- 固定黄色提示条:"运行中请勿操作目标窗口"(Start显示,Stop隐藏)

### 3.2 标定面板(每次运行必须)
- ROI: 矩形/圆形(圆形由拖拽矩形生成内切圆:cx=x+w/2, cy=y+h/2, r=min(w,h)/2)
- 输入位置: 点击点(抢焦点)
- 发送按钮: 点击点
- ROI允许与发送按钮重合

### 3.3 阈值校准
- 触发: 用户手动点击"校准"或冷却后高亮提示(非强制)
- 采集5-10帧估计静态噪声,给出TH_HOLD推荐值并允许手动微调
- 默认未校准前TH_HOLD=0.02

---

## 4. 消息与流程

### 4.1 消息输入
- 列表模式: 一条消息一个条目,条目支持多行
- Enter=换行(不发送)
- 列表尾部自动保持空条目(最后条目非空时自动追加)
- Start时过滤空条目生成有效消息列表并锁定N,运行期间不重新过滤
- 粘贴支持多行并保留换行

### 4.2 自动化流程(每条消息)
对第i条消息:
1. 点击输入位置
2. 粘贴消息i(保留换行)
3. 单击发送按钮
4. 冷却1秒
5. 冷却结束抓取ROI帧作为参考frame_t0(每条消息重置)
6. 每秒采样1次,计算diff(frame_t, frame_t0)
7. 若diff≥TH_HOLD连续命中2次(约2秒保持改变)→判定通过,进入下一条i+1
8. 若未满足,持续等待(无限等待;靠Pause/Stop控制)

**发送成功/失败判定**: 完全依赖ROI变化,ROI选取必须与"发送后状态变化"强相关。

---

## 5. 变化检测

### 5.1 diff定义
- ROI转灰度
- 差异度: d = mean(abs(frame_t - frame_t0)) / 255.0, 范围[0,1]
- 圆形ROI: 仅统计圆内像素(mask)

### 5.2 "保持2秒"口径
- 1 FPS下连续2次命中即通过
- 若diff<TH_HOLD, hold_hits归零重新计数

---

## 6. 多显示器与平台能力

### 6.1 坐标与截图
- 坐标: 虚拟桌面绝对坐标记录ROI、输入点、发送点
- 截图: 整个虚拟桌面截图后裁剪ROI

### 6.2 Windows
- Per-Monitor DPI aware,避免缩放偏移
- Qt初始化前调用SetProcessDpiAwarenessContext
- 若真正失败(非"已设置过"),显示警告横幅:"⚠️ DPI感知设置失败,坐标可能偏移。建议在100%缩放下运行或重启应用"

### 6.3 macOS
- 需屏幕录制与辅助功能权限;UI启动自检并提示
- **仅支持单显示器环境**,多显示器暂不支持

---

## 7. 控制逻辑

**Pause**: 冻结当前状态、计数器、frame_t0与消息列表快照  
**Resume**: 检测消息列表是否变化;未变化继续使用同一frame_t0与计数器;已变化则停止并提示"检测到消息列表已修改,自动化已停止,请重新Start"  
**Stop**: 立即停止,回到Idle

---

## 8. 边界条件与异常

### 8.1 权限与系统能力
- macOS未授权屏幕录制/辅助功能: 禁止Start并提示开启路径
- Windows DPI设置失败: 显示可关闭警告横幅

### 8.2 运行期异常
- 截图失败: 自动重试3次(间隔500ms);仍失败弹出模态对话框,标题"无法获取屏幕截图",内容含可能原因与建议,按钮"重试"/"查看日志"/"关闭"(回Idle)
- 坐标越界(点/ROI在虚拟桌面外): 禁止Start并提示重新标定
- 剪贴板粘贴失败: 记录日志并继续(依赖ROI变化判定)
- 目标窗口失焦/被遮挡: 不强制干预,提醒用户不操作;若ROI变化异常导致无限等待,用户可Pause/Stop

---

## 9. 验收标准

1. Always on top;Start后吸附到发送按钮所在屏幕右下角(边距12±2px),Countdown倒计时2秒后切换到Sending;黄色提示条Start显示、Stop隐藏
2. 每次运行必须完成ROI/输入点/发送点标定;ROI支持矩形与圆形(圆形为内切圆,diff仅统计圆内);ROI允许与发送点重合
3. 列表模式:条目支持多行,Enter换行,尾部空条目自动补,Start时过滤空条目并锁定N,支持多行粘贴保留换行
4. 每条消息: 点击输入点→粘贴→点击发送→冷却1秒→采集frame_t0→1 FPS采样diff; diff≥TH_HOLD连续命中2次推进,中断后hold_hits归零;未满足可无限等待
5. Pause冻结状态/计数器/frame_t0/消息列表快照;Resume检测消息变化,未变化沿用frame_t0,已变化停止并提示;Stop立即回Idle
6. 校准采集5-10帧给出TH_HOLD推荐值并可微调;未校准前TH_HOLD=0.02
7. Windows: Per-Monitor DPI aware,设置失败显示警告横幅
8. macOS: 权限自检,未授权禁用Start;仅支持单显示器

---

## 10. 风险与对策

| 风险 | 对策 |
|------|------|
| ROI选择不当导致误判/漏判 | UI提示"ROI应与发送后状态变化强相关";提供校准与手动微调 |
| 多显示器+DPI引发坐标偏移 | Windows强制Per-Monitor DPI aware,失败显示警告;提供重新标定 |
| macOS权限导致不可用 | 启动自检、清晰引导,未授权禁用Start;仅支持单显示器 |
| 无限等待导致误以为卡死 | 状态明确显示WaitingHold;日志显示diff/hold_hits;Pause/Stop可用 |

---

## 附录: 核心术语

- **ROI**: Region of Interest,屏幕上检测变化的区域
- **frame_t0**: 每条消息发送后、冷却结束时采集的参考帧
- **TH_HOLD**: 变化判定阈值;diff连续命中2次即通过
- **虚拟桌面**: 多显示器合成的统一坐标空间(Windows支持多屏;macOS本版本仅支持单屏)
- **i/N**: 当前消息索引/总有效消息数(i为1-based显示,如1/5表示第一条消息)
