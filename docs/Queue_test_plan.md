# 跨平台 ROI 变化驱动自动化工具 测试计划

版本: v1.1-精简版  
日期: 2026-01-02

---

## 1. 测试目标

1. 验证核心自动化流程: 逐条发送、冷却、frame_t0重置、1 FPS采样、连续2次命中推进
2. 验证UI行为: Always on top、吸附右下角、2秒倒计时、进度/状态/日志、Pause/Resume/Stop语义
3. 验证标定与ROI: 矩形/圆形ROI、圆形内切圆与mask、ROI与发送点可重合
4. 验证阈值校准: 静态噪声估计、推荐TH_HOLD展示与可微调、默认值兜底
5. 验证跨平台与多显示器: 虚拟桌面坐标、Windows DPI缩放、macOS权限自检
6. 验证Pause消息变化检测逻辑

---

## 2. 测试环境矩阵

### 2.1 Windows
- OS: Windows 10/11
- 显示: 单屏、双屏(主屏在左/右;副屏在上/下;虚拟桌面含负坐标)
- DPI缩放: 100% / 125% / 150%
- 目标应用: 浏览器、VS Code、Cursor(任选组合)

### 2.2 macOS
- OS: macOS 13+
- 显示: **仅单显示器**
- 权限场景: 首次启动未授权、授权后重启、运行中撤销权限
- 目标应用: 浏览器、VS Code/Cursor(任选组合)

---

## 3. 进入/退出标准

### 3.1 进入标准
- 已提供可运行安装包/可执行程序
- 已实现PRD核心功能与UI
- 已提供基本日志输出(包含状态、diff、hold_hits)

### 3.2 退出标准(MVP验收)
- P0用例100%通过
- P1用例≥90%通过,且失败项有明确已知问题与规避方案
- 连续运行30分钟无崩溃

---

## 4. 测试数据准备

**消息列表样例**:
- S1: 3条短文本(含空条目)
- S2: 2条多行文本(含换行、空行)
- S3: 20条混合文本(用于稳定性)

**ROI建议**:
- R1(强变化): 选择"发送后必然新增一条消息"的区域(如聊天列表底部)或"发送按钮disabled→enabled切换"的区域
- R2(弱变化): 选择静态区域(如窗口标题栏、空白区域)
- 测试前使用"抓取ROI预览图"确认选择正确

---

## 5. P0用例(必须通过)

### UI-001 Always on top
- 前置: 启动应用
- 步骤: 将运行面板置于其他窗口后方尝试遮挡
- 期望: 运行面板始终置顶

### UI-002 Start吸附右下角
- 前置: 完成标定与消息输入
- 步骤: 点击Start
- 期望: 运行面板移动到**发送按钮坐标所在屏幕**右下角;面板右边距与下边距均在[10px, 14px]范围内;面板完全可见

### UI-003 Start倒计时2秒
- 前置: 完成标定与消息输入
- 步骤: 点击Start
- 期望: 状态显示"Countdown";倒计时从2.0递减到0(约2秒);倒计时结束状态切换到"Sending";日志显示Start时间戳T0与第一次点击输入点时间戳T1,T1-T0应在[1.9, 2.1]秒范围内

### UI-004 固定提示条显示
- 前置: 完成标定
- 步骤: 点击Start;观察提示条;点击Stop
- 期望: Start时运行面板顶部显示黄色背景提示条"运行中请勿操作目标窗口";Stop后提示条隐藏

### MSG-001 列表尾部空条目自动追加
- 前置: 打开消息列表
- 步骤: 在最后一条输入非空文本
- 期望: 自动新增一个空条目在末尾

### MSG-002 发送时忽略空条目
- 前置: 消息列表包含空条目与非空条目(如3条非空+2条空)
- 步骤: Start运行
- 期望: 仅对非空条目计入N并执行发送(N=3);空条目被跳过;进度显示1/3、2/3、3/3

### MSG-003 Enter=换行(不触发发送)
- 前置: 在某条消息条目中编辑
- 步骤: 按Enter
- 期望: 插入换行;消息编辑未结束;无自动发送行为

### MSG-004 多行粘贴保留换行
- 前置: 准备包含多行文本的剪贴板内容
- 步骤: 粘贴到消息条目;Start运行发送
- 期望: 目标应用输入框中呈现与原文本一致的换行结构

### CAL-001 未标定阻止Start
- 前置: 未完成标定(ROI/输入点/发送点任一缺失)
- 步骤: 点击Start
- 期望: Start禁用或弹出提示"请先完成标定"

### CAL-002 ROI支持矩形/圆形(圆形为内切圆)
- 前置: 进入标定
- 步骤: 拖拽矩形生成ROI;选择圆形ROI;确认预览显示圆形边界
- 期望: 圆形ROI为矩形内切圆(cx=x+w/2, cy=y+h/2, r=min(w,h)/2);预览正确

### CAL-003 ROI允许与发送点重合
- 前置: 标定ROI覆盖发送按钮区域
- 步骤: 标定发送点位于ROI内
- 期望: 允许保存标定;Start可正常运行

### ENG-001 每条消息流程正确(点击→粘贴→点击发送→冷却1s)
- 前置: 标定完成;选择R1 ROI;消息S1
- 步骤: Start
- 期望: 对每条消息严格按顺序执行;两条消息之间必有1秒冷却;日志可见各阶段(Sending/Cooling/WaitingHold)

### ENG-002 冷却结束后采集frame_t0(每条消息重置)
- 前置: 消息S1(3条);R1 ROI
- 步骤: Start;观察日志
- 期望: 每条消息冷却结束时日志显示"采集frame_t0";下一条消息会重新采集;不沿用上一条

### DET-001a 1 FPS采样与连续2次命中判定(场景A: 连续命中)
- 前置: 消息S1;R1 ROI;TH_HOLD设置为可触发
- 步骤: Start
- 期望: WaitingHold状态下日志每秒记录一次diff(时间戳间隔1.0±0.1秒);当diff≥TH_HOLD连续两次(hold_hits=1→2),推进下一条

### DET-001b 1 FPS采样与连续2次命中判定(场景B: 中断后重新命中)
- 前置: 构造ROI变化场景:第1秒diff=0.03(≥0.02),第2秒diff=0.01(<0.02),第3-4秒diff=0.03
- 步骤: Start
- 期望: 第1秒hold_hits=1;第2秒diff<TH_HOLD,hold_hits归零(日志显示"hold_hits=0");第3-4秒重新计数hold_hits=1→2;第4秒后推进(总等待约4秒)

### CTRL-001 Pause冻结frame_t0与计数器
- 前置: 运行中进入WaitingHold;hold_hits可能为0或1
- 步骤: 点击Pause,等待5秒;点击Resume
- 期望: 暂停期间diff/hold_hits不再更新;恢复后继续沿用同一frame_t0与hold_hits计数

### CTRL-002 Stop立即停止并回Idle
- 前置: 运行中任意状态
- 步骤: 点击Stop
- 期望: 立即停止自动化;状态回Idle;进度停止增长

### CTRL-003 Pause期间消息变化检测
- 前置: 消息列表5条;运行到第3条时Pause
- 步骤: Pause期间删除第4、5条消息;点击Resume
- 期望: 弹出提示对话框"检测到消息列表已修改,自动化已停止。若需继续,请重新Start。";状态回到Idle;日志记录消息列表变化事件

### CTRL-004 Pause期间未变化正常Resume
- 前置: 消息列表5条;运行到第3条时Pause
- 步骤: Pause期间不修改消息列表;点击Resume
- 期望: 继续从第3条的WaitingHold状态执行;沿用同一frame_t0

### DET-002 无限等待(未命中时不会自动失败)
- 前置: 选择R2 ROI(变化不明显);TH_HOLD较高
- 步骤: Start
- 期望: 进入WaitingHold后可无限等待;不会自动超时失败;用户可Stop退出

---

## 6. P1用例(重要,建议通过)

### CAL-004 标定坐标越界阻止Start
- 前置: 造成ROI或点位在虚拟桌面外(或缩放/拔掉屏幕导致)
- 步骤: 点击Start
- 期望: 阻止Start;提示重新标定

### DET-003 圆形ROI mask生效范围正确
- 前置: 圆形ROI;构造ROI内只有圆外区域变化的场景
- 步骤: Start并观察diff
- 期望: 圆外变化不计入diff;diff保持较低(<TH_HOLD)

### CALI-001 校准按钮生成TH_HOLD推荐值并可编辑
- 前置: 标定完成
- 步骤: 点击"校准";记录推荐TH_HOLD;手动修改TH_HOLD
- 期望: 日志显示"采集帧1/K...K/K"(K∈[5,10]);推荐值出现且在合理范围[0.005, 0.2];UI展示mu、sigma、TH_rec(格式如"推荐阈值:0.018(噪声均值=0.003,σ=0.005)");手动修改生效

### CALI-002 未校准前默认TH_HOLD=0.02
- 前置: 不点击校准
- 步骤: Start;查看UI或日志
- 期望: TH_HOLD使用默认0.02

### CALI-003 冷却结束后校准按钮高亮提示
- 前置: 完成标定,Start运行第一条消息
- 步骤: 冷却1秒结束后观察UI
- 期望: 校准按钮高亮/闪烁/显示提示文本(如"建议校准")(非强制弹窗)

### LOG-001 日志环形缓冲不无限增长
- 前置: 运行较长时间(例如10分钟)
- 步骤: 观察日志显示
- 期望: 日志有最大条数限制(200条);旧条目自动删除;应用无明显卡顿

### WIN-001 Windows DPI 100/125/150坐标一致性
- 前置: 分别在不同缩放下运行并标定同一位置
- 步骤: Start并观察点击是否命中目标输入框/按钮
- 期望: 点击位置准确(偏差≤5px物理像素);无系统缩放导致的明显偏移

### WIN-002 Windows DPI设置失败警告横幅
- 前置: 在不支持DPI aware的旧系统上运行(或模拟设置失败)
- 步骤: 启动应用
- 期望: 主窗口显示可关闭的黄色警告横幅:"⚠️ DPI感知设置失败,坐标可能偏移。建议在100%缩放下运行或重启应用"

### MAC-001 macOS未授权屏幕录制/辅助功能时禁止Start
- 前置: 首次启动不授予权限
- 步骤: 尝试Start
- 期望: Start禁用;显示缺失权限与引导文案(含系统设置路径)

### MAC-002 macOS授权后可正常运行
- 前置: 授权屏幕录制与辅助功能并重启
- 步骤: 完成标定,Start
- 期望: 可正常截图、点击、粘贴与判定推进

### ERR-001 截图失败重试与错误对话框
- 前置: 运行中模拟截图失败(如撤销macOS屏幕录制权限)
- 步骤: 触发截图失败
- 期望: 自动重试3次(日志显示"截图失败,重试1/3...3/3");每次间隔约500ms;仍失败后弹出模态对话框,标题"无法获取屏幕截图",内容包含可能原因与建议操作,按钮"重试"/"查看日志"/"关闭";点击"关闭"后状态回Idle

---

## 7. P2用例(增强,视时间)

### MON-001 多显示器负坐标布局(副屏在左侧) - Windows only
- 前置: 双屏布局使虚拟桌面出现负坐标
- 步骤: 在左屏标定并运行
- 期望: ROI裁剪与点击坐标正确

### MON-002 双屏环境发送按钮在不同屏幕 - Windows only
- 前置: 双屏环境,目标窗口在屏幕1,发送按钮在屏幕2
- 步骤: 标定后Start
- 期望: 运行面板吸附到屏幕2右下角(发送按钮所在屏幕)

### STAB-001 长时间运行稳定性(30分钟)
- 前置: 消息S3(20条);选择R1 ROI;TH_HOLD合理
- 步骤: Start,持续30分钟
- 期望: 无崩溃、异常退出;状态与日志持续更新;CPU占用(平均值)≤10%(单核,1 FPS采样下;峰值≤20%);内存占用增长<50MB(30分钟内)

---

## 8. 验收清单(MVP)

- P0用例全部通过(含CTRL-003/CTRL-004消息变化检测)
- Windows: 至少完成1种多屏布局+2种DPI缩放通过核心流程
- macOS: 完成"未授权阻止Start"与"授权后运行"两项;确认仅单显示器环境
- 稳定性: 30分钟无崩溃(STAB-001)

---

## 附录: ROI选择建议

ROI应包含"发送后必然变化"的区域,例如:
- 消息列表新增一条
- 发送按钮状态变化(enabled/disabled/loading)
- 回执/进度/提示出现

避免选择:
- 动画/闪烁区域(易误判)
- 无变化区域(导致无限等待)
