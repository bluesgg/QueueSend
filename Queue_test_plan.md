# 跨平台 ROI 变化驱动自动化工具（Windows / macOS）测试计划与用例

版本：v1.1（根据可交付性审查反馈修订）  
作者：ChatGPT  
日期：2026-01-01

---

## 1. 测试目标
1. 验证核心自动化流程严格符合规格：逐条发送、冷却、frame_t0 重置、1 FPS 采样、连续 2 次命中推进。
2. 验证 UI 行为：Always on top、吸附右下角、2 秒倒计时、进度/状态/日志显示、Pause/Resume/Stop 语义。
3. 验证标定与 ROI：矩形/圆形 ROI、圆形内切圆与 mask 生效、ROI 与发送点可重合。
4. 验证阈值校准：静态噪声估计、推荐 TH_HOLD 展示与可微调、默认值兜底。
5. 验证跨平台与多显示器：虚拟桌面坐标、Windows DPI 缩放、macOS 权限自检。
6. 验证 Pause消息变化检测逻辑。

---

## 2. 测试范围

### 2.1 In-Scope
- UI：运行面板、消息输入、标定流程、校准功能
- 自动化：Countdown/Sending/Cooling/WaitingHold/Paused/Stop
- 变化检测：diff 定义、mask、连续命中逻辑、hold_hits 重置
- 多显示器与坐标：虚拟桌面截图裁剪（Windows）
- 平台能力：Windows DPI aware、macOS 屏幕录制/辅助功能权限

### 2.2 Out-of-Scope（本轮不测）
- 目标窗口移动/缩放/滚动时的正确性（规格明确不支持）
- 自动识别控件/视觉识别输入框、按钮
- 网络或目标应用内部发送逻辑正确性（完全由 ROI 变化判定）
- macOS 多显示器环境（本版本明确不支持）

---

## 3. 测试方法与环境

### 3.1 测试方法
- 功能测试（手动为主，关键算法单元测试）
- 场景测试（多屏、DPI、权限拒绝/撤销）
- 稳定性测试（长时间 WaitingHold、循环发送）

### 3.2 测试环境矩阵

#### Windows
- OS：Windows 10/11
- 显示：
  - 单屏
  - 双屏（主屏在左/右；副屏在上/下；虚拟桌面含负坐标）
- DPI 缩放：100% / 125% / 150%
- 目标应用：浏览器（任一可用）、VS Code、Cursor（任选其一组合）

#### macOS
- OS：macOS 13+
- 显示：**仅单显示器**
- 权限场景：
  - 首次启动未授权
  - 授权后重启
  - 运行中撤销权限（系统设置中关闭）
- 目标应用：浏览器、VS Code/Cursor（任选其一组合）

---

## 4. 进入/退出标准

### 4.1 进入标准
- 已提供可运行安装包/可执行程序
- 已实现 PRD 中定义的核心功能与 UI
- 已提供基本日志输出（至少包含状态、diff、hold_hits）

### 4.2 退出标准（MVP 验收）
- P0 用例 100% 通过
- P1 用例 ≥ 90% 通过，且失败项有明确已知问题与规避方案
- 连续运行 30 分钟无崩溃（稳定性用例通过）

---

## 5. 测试数据准备
- 消息列表样例：
  - S1：3 条短文本（含空条目）
  - S2：2 条多行文本（含换行、空行）
  - S3：20 条混合文本（用于稳定性）

- ROI 建议准备：
  - R1（强变化）：选择目标应用中"发送后必然新增一条消息"的区域（如聊天列表底部）或"发送按钮 disabled→enabled 切换"的区域
  - R2（弱变化）：选择静态区域（如窗口标题栏、空白区域）
  - 测试前使用"抓取 ROI 预览图"确认选择正确

---

## 6. 用例列表（按优先级）

### 6.1 P0（必须通过）

#### UI-001 Always on top
- 前置：启动应用
- 步骤：将运行面板置于其他窗口后方尝试遮挡
- 期望：运行面板始终置顶

#### UI-002 Start 吸附右下角
- 前置：完成标定与消息输入
- 步骤：点击 Start
- 期望：运行面板移动到**发送按钮坐标所在屏幕**的右下角；面板右边距与下边距均在 [10px, 14px] 范围内（使用屏幕标尺工具测量）；面板完全可见不被遮挡

#### UI-003 Start 倒计时 2 秒
- 前置：完成标定与消息输入
- 步骤：点击 Start
- 期望：状态显示"Countdown"；倒计时从 2.0 递减到 0（约 2 秒）；倒计时结束状态切换到"Sending"，日志显示 Start 时间戳 T0 与第一次点击输入点时间戳 T1，T1-T0 应在 [1.9, 2.1] 秒范围内

#### UI-004 固定提示条显示
- 前置：完成标定
- 步骤：点击 Start；观察提示条；点击 Stop
- 期望：
  - Start 时运行面板顶部显示黄色背景提示条："运行中请勿操作目标窗口"
  - Stop 后提示条隐藏

#### MSG-001 列表尾部空条目自动追加
- 前置：打开消息列表
- 步骤：在最后一条输入非空文本
- 期望：自动新增一个空条目在末尾

#### MSG-002 发送时忽略空条目
- 前置：消息列表包含空条目与非空条目（如 3 条非空 + 2 条空）
- 步骤：Start 运行
- 期望：仅对非空条目计入 N 并执行发送（N=3）；空条目被跳过；进度显示 1/3、2/3、3/3

#### MSG-003 Enter=换行（不触发发送）
- 前置：在某条消息条目中编辑
- 步骤：按 Enter
- 期望：插入换行；消息编辑未结束；无自动发送行为

#### MSG-004 多行粘贴保留换行
- 前置：准备包含多行文本的剪贴板内容
- 步骤：粘贴到消息条目；Start 运行发送
- 期望：目标应用输入框中呈现与原文本一致的换行结构

#### CAL-001a 未标定 ROI
- 前置：仅标定输入点与发送点
- 步骤：点击 Start
- 期望：Start 禁用或弹出提示"请先标定 ROI"

#### CAL-001b 未标定输入点/发送点
- 前置：仅标定 ROI
- 步骤：点击 Start
- 期望：Start 禁用或弹出提示"请先标定输入点与发送点"

#### CAL-001c 完全未标定
- 前置：应用启动，未进行任何标定
- 步骤：点击 Start
- 期望：Start 禁用或弹出提示"请先完成标定"

#### CAL-002 ROI 支持矩形/圆形（圆形为内切圆）
- 前置：进入标定
- 步骤：拖拽矩形生成 ROI；选择圆形 ROI；确认预览显示圆形边界
- 期望：圆形 ROI 为矩形内切圆（中心 cx=x+w/2, cy=y+h/2，半径 r=min(w,h)/2）；预览正确

#### CAL-003 ROI 允许与发送点重合
- 前置：标定 ROI 覆盖发送按钮区域
- 步骤：标定发送点位于 ROI 内
- 期望：允许保存标定；Start 可正常运行

#### ENG-001 每条消息流程正确（点击→粘贴→点击发送→冷却 1s）
- 前置：标定完成；选择 R1 ROI；消息 S1
- 步骤：Start
- 期望：对每条消息严格按顺序执行；两条消息之间必有 1 秒冷却；日志可见各阶段（Sending/Cooling/WaitingHold）

#### ENG-002 冷却结束后采集 frame_t0（每条消息重置）
- 前置：消息 S1（3 条）；R1 ROI
- 步骤：Start；观察日志
- 期望：
  - 每条消息冷却结束时日志显示"采集 frame_t0"
  - 下一条消息会重新采集；不沿用上一条
  - 可通过在 WaitingHold 时修改 ROI 内容验证：第 2 条消息 frame_t0 基于第 2 条发送后的画面

#### DET-001a 1 FPS 采样与连续 2 次命中判定（场景 A：连续命中）
- 前置：消息 S1；R1 ROI；TH_HOLD 设置为可触发
- 步骤：Start
- 期望：WaitingHold 状态下日志每秒记录一次 diff（时间戳间隔 1.0±0.1 秒）；当 diff≥TH_HOLD 连续两次（hold_hits=1→2），推进下一条

#### DET-001b 1 FPS 采样与连续 2 次命中判定（场景 B：中断后重新命中）
- 前置：构造 ROI 变化场景：第 1 秒 diff=0.03（≥0.02），第 2 秒 diff=0.01（<0.02），第 3-4 秒 diff=0.03
- 步骤：Start
- 期望：
  - 第 1 秒：hold_hits=1
  - 第 2 秒：diff<TH_HOLD，hold_hits 归零（日志显示"hold_hits=0"）
  - 第 3-4 秒：重新计数 hold_hits=1→2
  - 第 4 秒后推进（总等待约 4 秒）

#### CTRL-001 Pause 冻结 frame_t0 与计数器
- 前置：运行中进入 WaitingHold；hold_hits 可能为 0 或 1
- 步骤：点击 Pause，等待 5 秒；点击 Resume
- 期望：暂停期间 diff/hold_hits 不再更新；恢复后继续沿用同一 frame_t0 与 hold_hits 计数

#### CTRL-002 Stop 立即停止并回 Idle
- 前置：运行中任意状态
- 步骤：点击 Stop
- 期望：立即停止自动化；状态回 Idle；进度停止增长

#### CTRL-003 Pause 期间消息变化检测
- 前置：消息列表 5 条；运行到第 3 条时 Pause
- 步骤：
  1. Pause 期间删除第 4、5 条消息
  2. 点击 Resume
- 期望：
  - 弹出提示对话框："检测到消息列表已修改，自动化已停止。若需继续，请重新 Start。"
  - 状态回到 Idle
  - 日志记录消息列表变化事件

#### CTRL-004 Pause 期间未变化正常 Resume
- 前置：消息列表 5 条；运行到第 3 条时 Pause
- 步骤：Pause 期间不修改消息列表；点击 Resume
- 期望：继续从第 3 条的 WaitingHold 状态执行；沿用同一 frame_t0

#### DET-002 无限等待（未命中时不会自动失败）
- 前置：选择 R2 ROI（变化不明显）；TH_HOLD 较高
- 步骤：Start
- 期望：进入 WaitingHold 后可无限等待；不会自动超时失败；用户可 Stop 退出

---

### 6.2 P1（重要，建议通过）

#### CAL-004 标定坐标越界阻止 Start
- 前置：通过异常方式造成 ROI 或点位在虚拟桌面外（或缩放/拔掉屏幕导致）
- 步骤：点击 Start
- 期望：阻止 Start；提示重新标定

#### DET-003 圆形 ROI mask 生效范围正确
- 前置：圆形 ROI；构造 ROI 内只有圆外区域变化的场景
- 步骤：Start 并观察 diff
- 期望：圆外变化不计入 diff；diff 保持较低（<TH_HOLD）

#### CALI-001 校准按钮生成 TH_HOLD 推荐值并可编辑
- 前置：标定完成
- 步骤：点击"校准"；记录推荐 TH_HOLD；手动修改 TH_HOLD
- 期望：
  - 日志显示"采集帧 1/K...K/K"（K∈[5,10]）
  - 推荐值出现且在合理范围 [0.005, 0.2]
  - UI 展示 mu、sigma、TH_rec（格式如"推荐阈值：0.018（噪声均值=0.003，σ=0.005）"）
  - 手动修改生效并用于后续判定

#### CALI-002 未校准前默认 TH_HOLD=0.02
- 前置：不点击校准
- 步骤：Start；查看 UI 或日志
- 期望：TH_HOLD 使用默认 0.02

#### CALI-003 冷却结束后校准按钮高亮提示
- 前置：完成标定，Start 运行第一条消息
- 步骤：冷却 1 秒结束后观察 UI
- 期望：校准按钮高亮/闪烁/显示提示文本（如"建议校准"）（非强制弹窗）

#### LOG-001 日志环形缓冲不无限增长
- 前置：运行较长时间（例如 10 分钟）
- 步骤：观察日志显示
- 期望：日志有最大条数限制（200 条）；旧条目自动删除；应用无明显卡顿

#### WIN-001 Windows DPI 100/125/150 坐标一致性
- 前置：分别在不同缩放下运行并标定同一位置
- 步骤：Start 并观察点击是否命中目标输入框/按钮
- 期望：点击位置准确（偏差 ≤5px 物理像素）；无系统缩放导致的明显偏移

#### WIN-002 Windows DPI 设置失败警告横幅
- 前置：在不支持 DPI aware 的旧系统上运行（或模拟设置失败）
- 步骤：启动应用
- 期望：主窗口显示可关闭的黄色警告横幅："⚠️ DPI 感知设置失败，坐标可能偏移。建议在 100% 缩放下运行或重启应用"

#### MAC-001 macOS 未授权屏幕录制/辅助功能时禁止 Start
- 前置：首次启动不授予权限
- 步骤：尝试 Start
- 期望：Start 禁用；显示缺失权限与引导文案（含系统设置路径）

#### MAC-002 macOS 授权后可正常运行
- 前置：授权屏幕录制与辅助功能并重启
- 步骤：完成标定，Start
- 期望：可正常截图、点击、粘贴与判定推进

#### ERR-001 截图失败重试与错误对话框
- 前置：运行中模拟截图失败（如撤销 macOS 屏幕录制权限）
- 步骤：触发截图失败
- 期望：
  - 自动重试 3 次（日志显示"截图失败，重试 1/3...3/3"）
  - 每次间隔约 500ms
  - 仍失败后弹出模态对话框：
    * 标题："无法获取屏幕截图"
    * 内容包含可能原因与建议操作
    * 按钮："重试"、"查看日志"、"关闭"
  - 点击"关闭"后状态回 Idle

---

### 6.3 P2（增强，视时间）

#### MON-001 多显示器负坐标布局（副屏在左侧）- Windows only
- 前置：双屏布局使虚拟桌面出现负坐标
- 步骤：在左屏标定并运行
- 期望：ROI 裁剪与点击坐标正确

#### MON-002 双屏环境发送按钮在不同屏幕 - Windows only
- 前置：双屏环境，目标窗口在屏幕 1，发送按钮在屏幕 2
- 步骤：标定后 Start
- 期望：运行面板吸附到屏幕 2 右下角（发送按钮所在屏幕）

#### STAB-001 长时间运行稳定性（30 分钟）
- 前置：消息 S3（20 条）；选择 R1 ROI；TH_HOLD 合理
- 步骤：Start，持续 30 分钟
- 期望：
  - 无崩溃、异常退出
  - 状态与日志持续更新
  - CPU 占用（平均值）≤ 10%（单核，1 FPS 采样下；峰值 ≤ 20%）
  - 内存占用增长 < 50MB（30 分钟内）

---

## 7. 缺陷记录模板（建议）
- 缺陷编号：
- 标题：
- 环境：OS/版本、DPI、显示器布局、目标应用
- 复现步骤：
- 实际结果：
- 期望结果：
- 日志/截图：
- 严重程度：P0/P1/P2
- 复现率：100% / 偶现（50%）/ 低频（<10%）
- 是否阻塞 MVP 验收：是/否

---

## 8. 验收清单（MVP）
- P0 用例全部通过（含新增的 CTRL-003/CTRL-004 消息变化检测）
- Windows：至少完成 1 种多屏布局 + 2 种 DPI 缩放通过核心流程
- macOS：完成"未授权阻止 Start"与"授权后运行"两项；确认仅单显示器环境
- 稳定性：30 分钟无崩溃（STAB-001）

---

## 9. 附录：ROI 选择建议（写入测试说明/用户指南）
- ROI 应包含"发送后必然变化"的区域，例如：
  - 消息列表新增一条
  - 发送按钮状态变化（enabled/disabled/loading）
  - 回执/进度/提示出现
- 避免选择：
  - 动画/闪烁区域（易误判）
  - 无变化区域（导致无限等待）
