# 调试日志功能更新总结

## 更新内容

为 QueueSend 自动化程序添加了全面的调试日志系统，用于帮助诊断程序崩溃和异常问题。

## 主要改动

### 1. 增强日志系统 (`app/core/logging.py`)

**新增 `FileLogger` 类**：
- 线程安全的文件写入
- 日志保存到项目根目录 `debug.log`
- 支持结构化的上下文信息
- 自动格式化异常和堆栈跟踪

**增强 `Logger` 类**：
- 添加文件日志输出（同时保持内存缓冲区）
- 新增 `exception()` 方法用于记录完整异常信息
- 所有日志方法支持额外的上下文参数
- 应用启动时自动清空旧日志

### 2. 自动化引擎调试信息 (`app/core/engine.py`)

在整个自动化流程中添加了详细的调试日志：

**工作线程生命周期**：
- 线程启动和结束
- 异常捕获和完整堆栈
- Finally 块执行状态

**消息处理循环**：
- 每条消息开始时记录索引、长度和预览
- 配置信息（ROI、点击点、阈值）
- 倒计时和停止检测

**操作步骤跟踪**：
- 点击输入点（坐标、结果、异常）
- 粘贴操作（文本长度、成功/失败）
- 点击发送点（坐标、结果、异常）
- 冷却阶段时长

**变化检测过程**：
- 参考帧捕获（frame_t0）
- 每次采样（frame_t）
- Diff 计算结果
- Hold hits 变化（旧值 → 新值）
- 循环迭代次数
- 检测通过条件

### 3. 截图模块调试信息 (`app/core/capture.py`)

**ROI 截图过程**：
- 截图开始和区域参数
- 每次重试尝试
- 图像形状和大小
- 灰度转换结果
- 失败原因和错误详情

### 4. 输入注入调试信息 (`app/core/os_adapter/input_inject.py`)

**鼠标操作**：
- 准备点击的坐标
- 鼠标移动结果
- 点击完成确认
- 操作异常和堆栈

**键盘操作**：
- 剪贴板设置（文本长度、线程信息）
- 粘贴快捷键发送
- 跨线程调用处理
- 超时和失败检测

### 5. 变化检测调试信息 (`app/core/diff.py`)

**Diff 计算**：
- 帧形状不匹配错误
- 圆形蒙版应用
- 像素数量统计
- 计算异常详情

### 6. 控制器增强 (`app/controller.py`)

**会话管理**：
- 应用启动时清空日志
- 自动化开始时记录完整配置
- 分隔线标识新会话
- 启动失败详情

## 日志特性

### 日志级别

- **DEBUG**: 详细操作步骤（鼠标移动、截图细节）
- **INFO**: 关键事件（状态变化、消息处理）
- **WARNING**: 警告信息（重试、可能失败）
- **ERROR**: 错误和异常（带完整堆栈）

### 日志格式

```
[时间戳] [级别] 消息内容 (上下文1=值1, 上下文2=值2, ...)
```

### 异常日志格式

```
[时间戳] [ERROR] 上下文消息
  Exception Type: 异常类型
  Exception Message: 异常消息
  Traceback:
完整的堆栈跟踪...
```

## 使用方法

### 查看日志

日志文件位置：`QueueSend/debug.log`

```bash
# 查看最新日志
tail -f debug.log

# 搜索错误
grep ERROR debug.log

# 查看特定消息的处理过程
grep "idx=0" debug.log
```

### 排查崩溃

1. 运行程序直到崩溃
2. 打开 `debug.log`
3. 查看最后几条日志确定崩溃位置
4. 搜索 `[ERROR]` 查看异常信息
5. 查看完整的堆栈跟踪

### 性能分析

- 统计每条消息的处理时间
- 查看 WaitingHold 的循环次数
- 识别慢操作（截图、diff 计算）

## 隐私和安全

- 日志包含消息内容的前 100 个字符
- 日志文件仅保存在本地
- 每次启动应用自动清空旧日志
- 可手动删除 `debug.log` 文件

## 性能影响

- 日志写入为异步操作，对主流程影响极小（< 1ms）
- 失败的日志写入会被静默忽略，不影响程序运行
- 线程安全设计，支持并发写入

## 文件清单

更新的文件：
- `app/core/logging.py` - 新增 FileLogger 类和文件日志功能
- `app/core/engine.py` - 添加全面的自动化流程调试日志
- `app/core/capture.py` - 添加截图过程调试信息
- `app/core/os_adapter/input_inject.py` - 添加输入操作调试信息
- `app/core/diff.py` - 添加 diff 计算调试信息
- `app/controller.py` - 添加会话管理和启动日志

新增的文件：
- `DEBUG_LOG.md` - 调试日志详细使用说明
- `CHANGELOG.md` - 本更新总结（此文件）

更新的文档：
- `README.md` - 添加调试日志章节和故障排查指引

## 测试验证

已通过以下测试：
- ✅ 日志文件创建
- ✅ 不同级别的日志写入
- ✅ 上下文信息记录
- ✅ 异常堆栈跟踪
- ✅ 线程安全性
- ✅ 文件自动清空

## 向后兼容性

- 完全向后兼容，不影响现有功能
- 日志系统为可选功能，失败不影响程序运行
- 不需要用户配置，开箱即用

## 下一步建议

1. 在实际使用中测试日志的完整性
2. 根据用户反馈调整日志详细程度
3. 考虑添加日志文件大小限制和轮转机制
4. 可选：添加日志级别配置（仅 ERROR/全部）

