# 跨平台 ROI 变化驱动自动化工具（Windows / macOS）PRD

版本：v1.1（根据可交付性审查反馈修订）  
作者：ChatGPT（产品经理/全栈视角）  
日期：2026-01-01

---

## 1. 背景与问题定义
在浏览器、Cursor、VS Code、antigravity 等目标应用中，用户需要批量发送多条文本消息。现有方式依赖人工逐条粘贴与点击发送，效率低且容易出错。目标是提供一个跨平台桌面工具，通过"点击 + 剪贴板粘贴 + 点击发送"的自动化方式发送消息，并通过 ROI（Region of Interest）区域的视觉变化判定发送是否完成，从而推进下一条。

该方案的核心约束：不直接读取目标应用内部状态，完全依赖屏幕 ROI 的变化检测来判断"发送后状态变化"是否发生。

---

## 2. 目标与成功指标

### 2.1 目标（Goals）
1. 在 Windows/macOS 上提供一套可运行的自动化工具：
   - 支持消息列表输入（多行、条目模式）
   - 每次运行可完成标定（ROI、输入点、发送点）
   - 运行时按固定流程逐条发送，并以 ROI 变化作为推进条件
2. 提供运行面板小窗（Always on top），可控 Pause/Resume/Stop，并显示进度与简要日志。
3. 提供 TH_HOLD 阈值校准能力（自动推荐 + 手动微调），降低"误判/漏判"风险。

### 2.2 成功指标（Success Metrics）
- 可用性：用户在 2 分钟内完成一次标定并成功运行一次发送流程。
- 正确性：在用户选择"与发送后状态变化强相关"的 ROI 前提下，连续发送 N 条消息时，系统能在 ROI 变化满足条件后自动进入下一条，Pause/Resume/Stop 行为符合定义。
- 稳定性：连续运行 30 分钟无崩溃；CPU 占用稳定（以 1 FPS 采样为主）。

---

## 3. 范围说明

### 3.1 适用平台与目标应用
- 平台：Windows、macOS（macOS 仅支持单显示器环境）
- 目标应用：浏览器、Cursor、VS Code、antigravity（仅作为被操作窗口，不做集成）

### 3.2 前提假设（Assumptions）
- 目标窗口在运行期间不移动/不缩放/不滚动；否则坐标可能失效。
- 每次运行必须重新标定（ROI、输入点、发送点）。
- 发送失败/成功的判定完全依赖 ROI 变化（无其它兜底）。

### 3.3 非目标（Non-Goals）
- 不支持在运行中自动跟踪目标窗口位置变化。
- 不支持自动识别输入框/发送按钮（不做视觉识别/控件识别），只使用用户标定的点。
- 不支持有限等待或超时自动失败（等待可无限，依赖 Pause/Stop 控制）。
- 不支持在目标应用内部注入、读取 DOM/可访问性树或插件级集成。

---

## 4. 用户与使用场景

### 4.1 目标用户
- 需要批量发送文本、并希望减少重复操作的个人用户/研发人员。

### 4.2 核心场景
1. 用户打开目标应用并定位到可发送消息的界面。
2. 启动工具，录入多条消息。
3. 运行前进行标定：选择 ROI、输入点、发送点，必要时校准阈值。
4. 点击 Start，倒计时后开始自动化，逐条发送并等待 ROI 变化满足条件后继续。
5. 过程中可 Pause/Resume/Stop。

---

## 5. 需求规格

### 5.1 UI/交互

#### 5.1.1 运行面板（小窗）
- Always on top。
- Start 后自动吸附到**发送按钮坐标所在屏幕**的右下角（边距 12±2px 逻辑像素）。
- Start 后先倒计时 2 秒，再执行自动化。
- 面板显示：
  - 进度：i/N（i 从 1 开始显示，例如第一条消息显示 1/5）
  - 状态：Idle / Countdown / Sending / Cooling / WaitingHold / Paused
  - 控制：Pause/Resume/Stop
  - 简要日志（环形缓冲，最多 200 条；旧条目自动删除）
- 运行中用户输入：不干预自动化逻辑。
- MUST 在运行面板顶部显示固定提示条（黄色背景）："运行中请勿操作目标窗口"；Start 时显示，Stop 后隐藏。

#### 5.1.2 标定面板
每次运行必须完成标定：
- ROI：支持矩形 ROI / 圆形 ROI
  - 圆形 ROI：由拖拽矩形生成内切圆（圆心为矩形中心，半径为短边/2）。
- 输入位置：点击点（用于抢焦点）
- 发送按钮：点击点（单击）
- ROI 允许与发送按钮重合。

#### 5.1.3 阈值校准
- 提供"校准按钮"。
- 触发时机：
  - 用户手动点击"校准"按钮
  - 建议：冷却结束后校准按钮高亮提示（非强制弹出）
- 行为：采集若干帧（建议 5–10 帧）估计静态噪声，给出 TH_HOLD 推荐值并显示。
- UI：显示推荐值，同时允许手动微调。
- 默认初始兜底值：0.02（未校准前）。

---

### 5.2 消息输入
- 列表模式：一条消息一个条目，条目支持多行。
- Enter = 换行（不触发发送）。
- 列表尾部自动保持一个空条目：最后条目非空时自动追加空条目。
- Start 时过滤空条目生成有效消息列表并锁定 N；运行期间不再重新过滤。
- 输入方式：剪贴板粘贴（需支持多行粘贴且保留换行）。

---

### 5.3 自动化流程（每条消息一致）
对第 i 条消息：
1. 点击输入位置（抢焦点）
2. 粘贴消息 i（保留换行）
3. 单击发送按钮
4. 冷却 1 秒（每条都执行）
5. 冷却结束抓取 ROI 帧作为本轮参考 frame_t0（每条消息都会重置）
6. 每秒采样 1 次，计算 diff(frame_t, frame_t0)
7. 若 diff ≥ TH_HOLD 连续命中 2 次（约 2 秒保持改变）
   - 判定通过，进入下一条 i+1
8. 若未满足，持续等待（无限等待；靠 Pause/Stop 控制）

发送失败处理：完全依赖 ROI 变化。因此 ROI 选取必须与"发送后状态变化"强相关。

---

### 5.4 变化检测（diff 与阈值）

#### 5.4.1 diff 默认定义
- ROI 转灰度。
- 差异度：d = mean(abs(frame_t - frame_t0)) / 255.0，范围 [0, 1]
- 圆形 ROI：仅统计圆内像素（mask）。

#### 5.4.2 "保持 2 秒"的口径
- 1 FPS 下连续 2 次命中即通过。
- 若 diff < TH_HOLD，hold_hits 归零重新计数。

---

### 5.5 多显示器与截图来源
- 截图来源：整个虚拟桌面截图后裁剪 ROI。
- 坐标：使用虚拟桌面绝对坐标记录输入点、发送点、ROI。
- Windows：需要 Per-Monitor DPI aware，避免缩放导致坐标偏移。
  - 若 DPI aware 设置失败，显示警告横幅："⚠️ DPI 感知设置失败，坐标可能偏移。建议在 100% 缩放下运行或重启应用"
- macOS：需要屏幕录制与辅助功能权限；UI 启动自检并提示。
  - **仅支持单显示器环境**，多显示器暂不支持。

---

### 5.6 控制逻辑
- Pause：冻结当前状态、计数器、frame_t0 与消息列表快照。
- Resume：检测消息列表是否变化；未变化则继续使用同一个 frame_t0 与计数器；已变化则停止并提示"检测到消息列表已修改，自动化已停止，请重新 Start"。
- Stop：立即停止，回到 Idle。

---

## 6. 边界条件与异常处理（PRD 要求）

### 6.1 权限与系统能力
- macOS：
  - 未授权屏幕录制：禁止 Start，并提示开启路径。
  - 未授权辅助功能（用于点击/键盘/剪贴板操作）：禁止 Start，并提示。
- Windows：
  - 在应用启动时（Qt 初始化前）调用 SetProcessDpiAwarenessContext
  - 检查返回值和错误码；若真正失败（系统不支持，非"已设置过"），显示可关闭的警告横幅

### 6.2 运行期异常
- 截图失败：自动重试 3 次（每次间隔 500ms）；仍失败则弹出模态对话框：
  - 标题："无法获取屏幕截图"
  - 内容："已重试 3 次失败 / 可能原因：macOS 权限被撤销、Windows DPI 设置异常、显示器配置变化 / 建议操作：检查权限设置、重启应用、重新标定"
  - 按钮："重试"（重新尝试 3 次）、"查看日志"、"关闭"（回到 Idle）
- 坐标越界（点/ROI 在虚拟桌面外）：禁止 Start 并提示重新标定。
- 剪贴板粘贴失败：记录日志并继续（依赖 ROI 变化判定推进）。
- 目标窗口失焦/被遮挡：不做强制干预，但提醒用户不要操作；若 ROI 变化异常导致无限等待，用户可 Pause/Stop。

---

## 7. 数据与配置
- 运行期配置（本次运行内）：
  - ROI（形状、坐标）
  - 输入点、发送点
  - TH_HOLD 当前值（校准推荐值或手动值）
  - 消息列表（Start 时过滤空条目后的有效序列，锁定 N）
- 本 PRD 不要求跨次持久化（每次运行重新标定），但实现可选择保存到本地以便复用（若实现需补充隐私说明）。

---

## 8. 验收标准（Acceptance Criteria）

### 8.1 UI/交互
1. 工具窗口 Always on top。
2. 点击 Start 后：运行面板吸附到发送按钮坐标所在屏幕的右下角（边距 12±2px 逻辑像素），状态显示 Countdown；倒计时从 2.0 递减到 0；倒计时结束状态切换到 Sending 才开始自动化。
3. 运行面板实时显示 i/N（1-based）与状态（Idle/Countdown/Sending/Cooling/WaitingHold/Paused），并可 Pause/Resume/Stop。
4. 运行面板顶部显示固定提示条（黄色背景）："运行中请勿操作目标窗口"；Start 时显示，Stop 后隐藏。

### 8.2 标定
5. 每次运行必须完成 ROI、输入点、发送点标定后才能 Start。
6. ROI 支持矩形与圆形；选择圆形时由用户拖拽矩形生成内切圆，diff 仅统计圆内像素。
7. ROI 允许与发送按钮重合。

### 8.3 消息输入
8. 列表模式：每条消息一个条目，条目支持多行；Enter 仅换行。
9. 列表尾部始终保留一个空条目；Start 时过滤空条目并锁定 N。
10. 支持多行粘贴并保留换行发送。

### 8.4 自动化流程
11. 对每条消息严格执行：点击输入点 → 粘贴 → 点击发送 → 冷却 1 秒。
12. 冷却结束后采集 frame_t0；之后按 1 FPS 采样计算 diff(frame_t, frame_t0)。
13. 当 diff ≥ TH_HOLD 连续命中 2 次即判定"保持改变"，进入下一条；中断后 hold_hits 归零。
14. 未满足时可无限等待，直到满足或用户 Stop。

### 8.5 控制逻辑
15. Pause：冻结状态、计数器、frame_t0 与消息列表快照；Resume 检测消息列表变化，未变化则继续沿用 frame_t0，已变化则停止并提示。
16. Stop：立即停止并回到 Idle。

### 8.6 阈值校准
17. 点击"校准"后采集 5–10 帧估计静态噪声并给出 TH_HOLD 推荐值；UI 展示并允许手动微调。
18. 未校准前 TH_HOLD 使用默认 0.02。

---

## 9. 风险与对策
1. ROI 选择不当导致误判/漏判：
   - 对策：在 UI 中提示"ROI 应与发送后状态变化强相关"；提供校准与阈值手动微调。
2. 多显示器 + DPI 引发坐标偏移：
   - 对策：Windows 强制 Per-Monitor DPI aware，设置失败时显示警告横幅；提供重新标定入口。
3. macOS 权限导致不可用：
   - 对策：启动自检、清晰引导，并在未授权时禁用 Start。
   - macOS 仅支持单显示器环境。
4. 无限等待导致用户误以为卡死：
   - 对策：状态明确显示 WaitingHold；日志显示当前 diff 值与命中计数；Pause/Stop 可用。

---

## 10. 里程碑（建议）
- M1：基础 UI + 标定 + 单屏截图裁剪 + 单条消息流程跑通
- M2：多条消息队列 + 状态机 + Pause/Resume/Stop + 消息变化检测
- M3：阈值校准 + 圆形 ROI mask
- M4：多显示器/虚拟桌面坐标完善 + Windows DPI/macOS 权限自检
- M5：测试矩阵覆盖与打包发布

---

## 11. 附录：术语
- ROI：Region of Interest，屏幕上用于检测变化的区域。
- frame_t0：每条消息发送后、冷却结束时采集的参考帧。
- TH_HOLD：变化判定阈值；diff 连续命中 2 次即通过。
- 虚拟桌面：多显示器合成的统一坐标空间（Windows 支持多屏；macOS 本版本仅支持单屏）。
